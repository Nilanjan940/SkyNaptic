/**
 * @file Firebase Security Rules for SkyNaptic Firestore database.
 *
 * Core Philosophy:
 * This ruleset prioritizes secure data access based on user roles and ownership.
 * It allows public read access to flight and alert data while restricting write access to authorized users.
 * User profiles and drones are strictly controlled by their respective owners.
 *
 * Data Structure:
 * - /userProfiles/{userId}: Stores individual user profile data. Only the user can read/write their own profile.
 * - /flights/{flightId}: Stores flight data. Publicly readable, writeable by authorized ATC users.
 * - /drones/{droneId}: Stores drone data. Publicly readable, writeable by the assigned drone operator.
 * - /alerts/{alertId}: Stores alert data. Publicly readable, writeable by authorized roles (not defined in this prototype).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if the user has the 'atc' role.
    function isATC() {
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == 'atc';
    }

    // Helper function to check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the user is the operator of a drone.
    // It verifies that the incoming resource's operatorId field matches the user's UID.
    function isDroneOperator() {
        return request.resource.data.operatorId == request.auth.uid;
    }
    
    // Helper function to check if the user is the existing operator of a drone.
    // It verifies that the existing resource's operatorId field matches the user's UID.
    function isExistingDroneOperator() {
      return resource.data.operatorId == request.auth.uid;
    }


    /**
     * @description Enforces strict user-ownership for user profile data.
     * @path /userProfiles/{userId}
     */
    match /userProfiles/{userId} {
      function isOwner() {
        return request.auth.uid == userId;
      }
      
      allow get: if isOwner();
      allow list: if false; // User listing is not permitted.
      allow create: if isOwner() && request.resource.data.id == userId;
      allow update: if isOwner() && request.resource.data.id == userId; //Enforce immutability of the 'id' field.
      allow delete: if isOwner();
    }

    /**
     * @description Allows public read access to flight data, with write access restricted to ATC users.
     * @path /flights/{flightId}
     */
    match /flights/{flightId} {
      allow get, list: if true;
      allow create, update, delete: if isATC(); 
    }
    
    /**
     * @description Allows authenticated read access to drone data, with write access restricted to the assigned operator.
     * @path /drones/{droneId}
     */
    match /drones/{droneId} {
      // Allow read for authenticated users (including ATC)
      allow get, list: if isAuthenticated();
      allow create: if isDroneOperator();
      allow update: if isExistingDroneOperator();
      allow delete: if isExistingDroneOperator();
    }

    /**
     * @description Allows authenticated read access to alert data, with write access restricted.
     * @path /alerts/{alertId}
     */
    match /alerts/{alertId} {
      allow get, list: if isAuthenticated();
      allow create, update, delete: if isATC(); // Allow ATC to manage alerts
    }
  }
}